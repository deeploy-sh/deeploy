version: "3"

vars:
  TAILWIND_CMD:
    sh: command -v tailwindcss >/dev/null 2>&1 && echo "tailwindcss" || echo "npx tailwindcss@latest"

tasks:
  # --- Infrastructure ---
  infra:up:
    desc: Start Postgres and Traefik
    cmds:
      - docker compose up -d postgres traefik

  infra:down:
    desc: Stop all infrastructure
    cmds:
      - docker compose down

  infra:reset:
    desc: Reset infrastructure (delete volumes and restart)
    cmds:
      - docker compose down -v
      - docker compose up -d postgres traefik

  # --- Shared ---
  tailwind:watch:
    cmds:
      - "{{.TAILWIND_CMD}} -i ./assets/css/input.css -o ./assets/css/output.css --watch"

  templ:server:
    cmds:
      - go tool templ generate --watch --proxy="http://localhost:8090" --cmd="go run ./cmd/server" --open-browser=false

  templ:docs:
    cmds:
      - go tool templ generate --watch --proxy="http://localhost:8090" --cmd="go run ./cmd/docs" --open-browser=false

  # --- Dev ---
  dev:tui:
    desc: TUI client
    cmds:
      - DEBUG=1 go run ./cmd/tui

  dev:server:
    desc: VPS server (starts Postgres and Traefik)
    deps: [infra:up]
    cmds:
      - task --parallel tailwind:watch templ:server

  dev:docs:
    desc: Docs website
    cmds:
      - task --parallel tailwind:watch templ:docs

  dev:all:
    desc: Run server + docs (ports 8090 + 8091)
    cmds:
      - task --parallel dev:server dev:docs
