# Production-ready config
# Dev: auto-loads docker-compose.override.yml
# Prod: install script uses only this file

# THE NETWORK: All containers that need to talk to each other must be here.
# Traefik routes traffic -> needs to reach containers -> must be in same network.
networks:
  deeploy:
    # Fixed name so Go code can join new containers to this network
    # See: internal/server/docker/docker.go -> NetworkName -> RunContainer()
    name: deeploy

services:
  # PostgreSQL - Optional, only starts with --profile postgres
  postgres:
    profiles: [postgres]
    image: postgres:16-alpine
    container_name: deeploy-postgres
    networks:
      - deeploy
    environment:
      POSTGRES_USER: deeploy
      POSTGRES_PASSWORD: deeploy
      POSTGRES_DB: deeploy
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U deeploy"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  traefik:
    image: traefik:v3.6
    container_name: deeploy-traefik
    networks:
      - deeploy
    command:
      #─────────────────────────────────────────────────────────────────────────
      # DOCKER PROVIDER
      # Traefik auto-discovers containers and reads their labels for routing
      #─────────────────────────────────────────────────────────────────────────

      # Enable Docker provider: auto-discover containers with traefik labels
      - "--providers.docker=true"
      # Security: Don't expose containers unless they have traefik.enable=true
      - "--providers.docker.exposedbydefault=false"
      # Network: Which Docker network to use when connecting to containers
      - "--providers.docker.network=deeploy"

      #─────────────────────────────────────────────────────────────────────────
      # ENTRYPOINTS (Ports where Traefik listens for traffic)
      #─────────────────────────────────────────────────────────────────────────

      # HTTP entrypoint on port 80
      # Used for: ACME HTTP challenge + redirect to HTTPS
      - "--entrypoints.web.address=:80"
      # HTTPS entrypoint on port 443
      # Used for: All actual traffic (encrypted)
      - "--entrypoints.websecure.address=:443"

      # Auto-redirect: HTTP → HTTPS
      # When someone visits http://... they get redirected to https://...
      # This ensures no accidental unencrypted traffic
      - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
      - "--entrypoints.web.http.redirections.entryPoint.scheme=https"

      #─────────────────────────────────────────────────────────────────────────
      # ACME / LET'S ENCRYPT (Automatic SSL Certificates)
      # ACME = Automatic Certificate Management Environment
      #─────────────────────────────────────────────────────────────────────────

      # Enable HTTP challenge for certificate verification
      # How it works:
      # 1. Traefik asks Let's Encrypt for a certificate
      # 2. Let's Encrypt visits http://yourdomain/.well-known/acme-challenge/xxx
      # 3. Traefik responds with a secret token (proves we control the domain)
      # 4. Let's Encrypt issues the certificate
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge=true"
      # Which entrypoint to use for the HTTP challenge (must be port 80)
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
      # Where to store certificates (persisted via volume)
      # IMPORTANT: Without persistence, new certs are requested on every restart
      # Rate limit: Max 50 certificates per week per domain!
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"

      #─────────────────────────────────────────────────────────────────────────
      # FILE PROVIDER
      # Traefik watches YAML files for dynamic routing configuration
      # Used for: Server domain routing (deeploy-app writes config files here)
      #─────────────────────────────────────────────────────────────────────────
      - "--providers.file.directory=/traefik/dynamic"
      - "--providers.file.watch=true"

    ports:
      # HTTP traffic (port 80) - used for ACME challenge + redirect to HTTPS
      - "80:80"
      # HTTPS traffic (port 443) - all actual encrypted traffic
      - "443:443"
    volumes:
      # Docker socket: Traefik reads container labels to configure routing
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Let's Encrypt certificates: persist across restarts
      # Without this volume, Traefik would request new certs on every restart
      # and hit Let's Encrypt rate limits (50 certs/week/domain)
      - letsencrypt_certs:/letsencrypt
      # Dynamic config: deeploy-app writes, Traefik reads (server domain routing)
      - /opt/deeploy/traefik:/traefik/dynamic
    restart: unless-stopped

  deeploy:
    image: ghcr.io/deeploy-sh/deeploy:${DEEPLOY_VERSION:-latest}
    container_name: deeploy-app
    networks:
      - deeploy
    ports:
      - "8090:8090"
    volumes:
      # Docker socket: App needs to build images and start/stop containers
      # Without this, the Go Docker SDK can't reach the host's Docker daemon
      - /var/run/docker.sock:/var/run/docker.sock
      # Dynamic config: App writes Traefik config files here (server domain routing)
      - /opt/deeploy/traefik:/traefik/dynamic
      # SQLite database file (only used when DB_DRIVER=sqlite)
      - /opt/deeploy/data:/data
    environment:
      DB_DRIVER: ${DB_DRIVER}
      DB_CONNECTION: ${DB_CONNECTION}
      JWT_SECRET: ${JWT_SECRET}
      ENCRYPTION_KEY: ${ENCRYPTION_KEY}
    restart: unless-stopped

volumes:
  postgres_data:
  # Let's Encrypt certificates storage
  # Persists SSL certs across container restarts to avoid rate limits
  letsencrypt_certs:
